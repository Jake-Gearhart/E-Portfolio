<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
</head>
<html>
    <body>
        <div id="background"></div>
        <div style="display: flex">Show Settings:<input type="checkbox" onclick="clearCardSelections(); document.querySelectorAll('.debug').forEach(elm => {if (this.checked == true) elm.classList.remove('debug-hidden'); else elm.classList.add('debug-hidden')})"></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">------------------------ Settings ------------------------</div>
        <div class="debug debug-hidden">(Will be visible in a settings menu)</div>
        <div class="debug debug-hidden">-</div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Max Board Bottom Width:<input type="range" min="100" max="300" value="135" oninput="maxBoardWidth = this.value/100; updateBoardTransform(); document.getElementById('max-board-width-text').innerHTML = `${(this.value/100).toFixed(2)} x Board Height (Default: 1.35)`"><div id="max-board-width-text">1.35 x Board Height (Default: 1.35)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Animation Speed:<input type="range" min="0" max="100" value="7" oninput="css.setProperty('--animation-time', `${this.value/20}s`); document.getElementById('animation-time-text').innerHTML = `${(this.value/20).toFixed(2)}s (Default: 0.35s)`"><div id="animation-time-text">0.35s (Default: 0.35s)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Long Press Time (Touch Screen):<input type="range" min="0" max="300" value="50" oninput="longPressTime = this.value/100; document.getElementById('long-press-time-text').innerHTML = `${(this.value/100).toFixed(2)}s (Default: 0.50s)`"><div id="long-press-time-text">0.50s (Default: 0.50s)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Opponent's Cards Face You:<input type="checkbox" oninput="css.setProperty('--opponent-card-rotation', this.checked ? '0deg' : '180deg')"></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Card Shadow:<input type="checkbox" oninput="css.setProperty('--card-shadow-image', this.checked ? `url('card-shadow.png')` : 'none')" checked></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Holofoil:<input type="checkbox" oninput="css.setProperty('--holofoil-display', this.checked ? 'inline-block' : 'none')" checked></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Focused Card Idle Animation:<input type="checkbox" oninput="css.setProperty('--focused-card-idle-speed', this.checked ? '5s' : '0s')" checked></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">------------------------ Debugging -----------------------</div>
        <div class="debug debug-hidden">(Only for testing)</div>
        <div class="debug debug-hidden">-</div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Board Height:<input type="range" min="0" max="200" value="100" oninput="boardHeightScale = this.value/100; updateBoardTransform(); document.getElementById('board-height-text').innerHTML = `${(this.value/100).toFixed(2)} x Screen Width (Default: 1)`"><div id="board-height-text">1.00 x Screen Width (Default: 1.00)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Top Padding:<input type="range" min="0" max="50" value="5" oninput="paddingTop = this.value/100; updateBoardTransform(); document.getElementById('padding-top-text').innerHTML = `${(this.value/100).toFixed(2)} x Screen Height (Default: 0.05)`"><div id="padding-top-text">0.05 x Board Height (Default: 0.05)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Bottom Padding:<input type="range" min="0" max="50" value="5" oninput="paddingBottom = this.value/100; updateBoardTransform(); document.getElementById('padding-bottom-text').innerHTML = `${(this.value/100).toFixed(2)} x Screen Height (Default: 0.15)`"><div id="padding-bottom-text">0.15 x Board Height (Default: 0.15)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Debug Background:<input type="checkbox" oninput="css.setProperty('--background-color', this.checked ? '#166953' : '#1b7f64')"></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Right Click Menu:<input type="checkbox" oninput="debugRightClickMenu = this.checked ? true : false"></div>
        <div style="position: absolute; bottom: 0;">0013</div>
        <game-board></game-board>
        <card-drop-zone position="board-user-discard"></card-drop-zone>
        <card-drop-zone position="board-user-active"></card-drop-zone>
        <card-drop-zone position="board-user-bench-1"></card-drop-zone>
        <card-drop-zone position="board-user-bench-2"></card-drop-zone>
        <card-drop-zone position="board-user-bench-3"></card-drop-zone>
        <card-drop-zone position="board-user-bench-4"></card-drop-zone>
        <card-drop-zone position="board-user-bench-5"></card-drop-zone>
        <card-drop-zone position="board-opponent-discard"></card-drop-zone>
        <card-drop-zone position="board-opponent-active"></card-drop-zone>
        <card-drop-zone position="board-opponent-bench-1"></card-drop-zone>
        <card-drop-zone position="board-opponent-bench-2"></card-drop-zone>
        <card-drop-zone position="board-opponent-bench-3"></card-drop-zone>
        <card-drop-zone position="board-opponent-bench-4"></card-drop-zone>
        <card-drop-zone position="board-opponent-bench-5"></card-drop-zone>
        <card-drop-zone position="board-stadium"></card-drop-zone>
        <pokemon-card position="board-opponent-bench-5" image-src="https://images.pokemontcg.io/swsh12/147_hires.png"></pokemon-card>
        <pokemon-card class="board-transform holofoil" position="board-opponent-active" image-src="https://images.pokemontcg.io/sv1/131_hires.png"></pokemon-card>
        <pokemon-card class="board-transform holofoil" position="board-user-active" image-src="https://images.pokemontcg.io/swsh6/61_hires.png"></pokemon-card>
        <pokemon-card class="board-transform holofoil" position="board-user-bench-1" image-src="https://images.pokemontcg.io/sv1/86_hires.png"></card-image></pokemon-card>
        <pokemon-card class="board-transform" position="board-user-bench-2" image-src="https://images.pokemontcg.io/swsh12/68_hires.png"></pokemon-card>
    </body>
</html>
<style>
    :root {
        /* Global Variables */
        --card-image-width-height-ratio: calc(734/1024);
        --card-width-height-ratio: calc(862/1152);
        --card-image-width: 12.5%;
        --card-width: calc(var(--card-image-width) * 862/734);

        --card-image-border-radius: 4.5% / calc(4.5% * var(--card-image-width-height-ratio));

        --stack-left: 0;
        --stack-bottom: 0;
        --stack-time: 0.35s;
        --stack-lower-layer-display: unset;

        /* Settings */
        --background-color: #1b7f64;
        --opponent-card-rotation: 180deg;
        --card-shadow-image: url('card-shadow.png');
        --holofoil-display: inline-block;
        --animation-time: 0.35s;
        --focused-card-idle-speed: 5s; /* Set to 0s to disable idle animation */
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;

        user-select: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;

        object-fit: contain;

        touch-action: manipulation;
    }

    .debug {
        display: flex;
        background-color: rgba(0,0,0,0.5);
    }
    .debug-hidden {
        display: none;
    }

    body {
        color: white;
        font-family: monospace;
        overflow: hidden;
    }

    #background {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        background-color: var(--background-color);
        z-index: -3 !important;
    }

    game-board {
        background-image: url('board.png');
        background-repeat: no-repeat;
        background-size: 100% 100%;
        z-index: -2 !important;
    }

    pokemon-card * {
        position: absolute;
        transition: all var(--animation-time);
    }

    .card-position {
        aspect-ratio: var(--card-width-height-ratio);
        transform: translate(-50%, 50%);
    }
    card-drop-zone .card-position {
        position: absolute;
        width: var(--card-image-width) !important;
        aspect-ratio: var(--card-image-width-height-ratio);
        border-radius: var(--card-image-border-radius);
        pointer-events: all;
        transition: background-color calc(var(--animation-time)/2);
    }
    card-drop-zone .card-position:hover {
        background-color: rgba(255,255,255,0.125);
    }

    game-board, .position-board-user-discard, .position-board-user-active, .position-board-user-bench-1, .position-board-user-bench-2, .position-board-user-bench-3, .position-board-user-bench-4, .position-board-user-bench-5, .position-board-opponent-discard, .position-board-opponent-active, .position-board-opponent-bench-1, .position-board-opponent-bench-2, .position-board-opponent-bench-3, .position-board-opponent-bench-4, .position-board-opponent-bench-5, .position-board-stadium {
        position: absolute;
        width: var(--board-width);
        height: var(--board-height);
        left: 0;
        bottom: 0;
        transform-origin: center bottom;
        transform: translateX(var(--board-translateX)) translateY(var(--board-translateY)) matrix3d(1,0,0,0,0,1,0,var(--board-depth-transform),0,0,1,0,0,0,0,1);
        transition: all var(--animation-time);
        pointer-events: none;
        z-index: -1;
    }

    .position-board-user-discard .card-position {
        width: var(--card-width);
        left: 94.5%;
        bottom: 19%;
    }
    .position-board-user-active .card-position {
        width: var(--card-width);
        left: 50%;
        bottom: 39%;
    }
    .position-board-user-bench-1 .card-position {
        width: var(--card-width);
        left: 24.3%;
        bottom: 14%;
    }
    .position-board-user-bench-2 .card-position {
        width: var(--card-width);
        left: 38%;
        bottom: 14%;
    }
    .position-board-user-bench-3 .card-position {
        width: var(--card-width);
        left: 51.7%;
        bottom: 14%;
    }
    .position-board-user-bench-4 .card-position {
        width: var(--card-width);
        left: 65.4%;
        bottom: 14%;
    }
    .position-board-user-bench-5 .card-position {
        width: var(--card-width);
        left: 79.1%;
        bottom: 14%;
    }
    .position-board-opponent-discard .card-position {
        width: var(--card-width);
        left: 5.5%;
        bottom: 81%;
    }
    .position-board-opponent-active .card-position {
        width: var(--card-width);
        left: 50%;
        bottom: 61%;
    }
    .position-board-opponent-bench-1 .card-position {
        width: var(--card-width);
        left: 75.3%;
        bottom: 86%;
    }
    .position-board-opponent-bench-2 .card-position {
        width: var(--card-width);
        left: 61.6%;
        bottom: 86%;
    }
    .position-board-opponent-bench-3 .card-position {
        width: var(--card-width);
        left: 47.9%;
        bottom: 86%;
    }
    .position-board-opponent-bench-4 .card-position {
        width: var(--card-width);
        left: 34.2%;
        bottom: 86%;
    }
    .position-board-opponent-bench-5 .card-position {
        width: var(--card-width);
        left: 20.5%;
        bottom: 86%;
    }
    .position-board-stadium .card-position {
        width: var(--card-width);
        left: 27.8%;
        bottom: 50%;
    }

    .position-board-opponent-discard .card-shadow, .position-board-opponent-active .card-shadow, .position-board-opponent-bench-1 .card-shadow, .position-board-opponent-bench-2 .card-shadow, .position-board-opponent-bench-3 .card-shadow, .position-board-opponent-bench-4 .card-shadow, .position-board-opponent-bench-5 .card-shadow {
        transform: rotate(var(--opponent-card-rotation))
    }

    .stack {
        transform: translateX(var(--board-translateX)) translateY(var(--board-translateY));
        z-index: 550;
    }
    .stack:not(.stack-top) {
        display: var(--stack-lower-layer-display);
        z-index: 450;
    }
    .stack .card-position {
        position: absolute;
        left: var(--stack-left);
        bottom: var(--stack-bottom);
        transition: all var(--animation-time), left var(--stack-time), bottom var(--stack-time);
    }
    .stack .card-shadow {
        transform: rotate(0);
    }

    .focused {
        transform: translateX(var(--board-translateX)) translateY(var(--board-translateY));
        z-index: 1000;
    }
    .focused .card-position {
        width: calc(0.4 * var(--board-width)); /* Width of focuseded card = 40% of board width */
        left: 25%;
        bottom: calc(50vh + var(--board-translateY)); /* focuseded card is centered vertically */
        animation: card-idle var(--focused-card-idle-speed) ease-in-out infinite;
        animation-delay: var(--animation-time); /* Wait for focused to complete before idle animation begins */
    }
    .focused .card-shadow {
        transform: rotate(0) matrix3d(1,0,0,0.0003,0,1,0,0,0,0,1,0,0,0,0,1);
    }

    .card-shadow {
        position: absolute;
        aspect-ratio: var(--card-width-height-ratio);
        width: 100%;
        background-image: var(--card-shadow-image);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        transition: all var(--animation-time), background calc(var(--animation-time) / 4) !important;
    }
    .selected .card-shadow {
        background-image: url('card-highlight.png') !important;
        animation: selected-card 2s ease-in-out infinite;
    }
    @keyframes selected-card {
        0% {
            filter: brightness(1);
        }
        50% {
            filter: brightness(1.25);
        }
    }

    card-image {
        position: absolute;
        aspect-ratio: 734/1024;
        width: calc(73400%/862);
        top: calc(6400%/1152);
        left: calc(6400%/862);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        border-radius: var(--card-image-border-radius);
        pointer-events: all;
    }
    .stack card-image {
        pointer-events: none;
    }

    .holofoil card-image::after {
        content: "";
        position: absolute;
        display: var(--holofoil-display);
        width: 100%;
        height: 100%;
        background-image: url('holofoil.gif');
        background-repeat: no-repeat;
        background-size: 100% 100%;
        mix-blend-mode: color-dodge;
        border-radius: var(--card-image-border-radius);
    }
    @keyframes card-idle {
        0% {
            transform: translate(-50%, 50%);
            animation-timing-function: ease-out;
        }
        25% {
            transform: translate(-50%, 50.5%);
            animation-timing-function: ease-in-out;
        }
        75% {
            transform: translate(-50%, 49.5%);
            animation-timing-function: ease-in;
        }
    }
</style>
<script>
    let paddingTop = 0.05
    let paddingBottom = 0.15
    let maxBoardWidth = 1.35
    let boardHeightScale = 1
    let longPressTime = 0.5
    let debugRightClickMenu = false

    const css = document.documentElement.style

    function updateBoardTransform () {
        const windowWidth = window.innerWidth
        const windowHeight = window.innerHeight
        const boardWidth = Math.min(windowWidth, windowHeight * (maxBoardWidth / boardHeightScale - paddingTop - paddingBottom))
        const boardHeight = boardWidth * boardHeightScale
        const paddingTopPX = paddingTop * windowHeight
        const paddingBottomPX = paddingBottom * windowHeight
        const available2DHeight = windowHeight - paddingTopPX - paddingBottomPX
        const offsetX = (windowWidth - boardWidth) / 2
        const offsetY = Math.min(0, (boardHeight - available2DHeight) / 2) - paddingBottomPX

        css.setProperty('--board-width', `${boardWidth}px`)
        css.setProperty('--board-height', `${boardHeight}px`)
        css.setProperty('--board-translateX', `${offsetX}px`)
        css.setProperty('--board-translateY', `${offsetY}px`)
        css.setProperty('--board-depth-transform', Math.min(0, (available2DHeight - boardHeight) / (available2DHeight * boardHeight)))
    }
    updateBoardTransform()

    window.addEventListener('resize', updateBoardTransform)
    function setStackPos () {
        css.setProperty('--stack-left', `calc(${cursorPos.x}px - var(--board-translateX))`)
        css.setProperty('--stack-bottom', `calc(${(window.innerHeight - cursorPos.y)}px + var(--board-translateY))`)
    }

    let cursorUpdateStackPos = false
    let cursorPos
    window.addEventListener('contextmenu', (event) => {
        if (debugRightClickMenu == false) event.preventDefault()
    })
    window.addEventListener('dragstart', (event) => event.preventDefault())
    window.addEventListener('mousemove', (event) => {
        cursorPos = {'x': event.clientX, 'y': event.clientY}
        if (cursorUpdateStackPos == true) setStackPos()
    })
    window.addEventListener('touchmove', (event) => {
        cursorPos = {'x': event.touches[0].clientX, 'y': event.touches[0].clientY}
        if (cursorUpdateStackPos == true) setStackPos()
    })
    window.addEventListener('click', (event) => {
        if (event.target != document.body && event.target.tagName != 'CARD-IMAGE') clearCardSelections()
    })
    window.addEventListener('mousedown', (event) => dropStack(event))
    window.addEventListener('mouseup', (event) => dropStack(event))

    function dropStack (event) {
        if (document.querySelectorAll('.stack').length > 0 && event.target.dropCards) {
            event.target.dropCards(document.querySelectorAll('.stack'))
            clearCardSelections()
        }
    }
    

    function clearCardSelections () {
        document.querySelectorAll('.focused').forEach(elm => elm.classList.remove('focused'))
        document.querySelectorAll('.selected').forEach(elm => elm.classList.remove('selected'))
        clearCardStack()
    }

    let stackAnimationTimeouts = []
    function clearCardStack () {
        cursorUpdateStackPos = false
        stackAnimationTimeouts.forEach(timeout => clearTimeout(timeout));
        css.setProperty('--stack-lower-layer-display', 'unset')
        css.setProperty('--stack-time', getComputedStyle(document.body).getPropertyValue('--animation-time'))
        document.querySelectorAll('.stack').forEach(elm => elm.classList.remove('stack'))
    }

    class CardDropZone extends HTMLElement {
        constructor () {
            super()
            this.position = this.position
        }

        connectedCallback () {
            this.cardContainer = document.createElement('hitbox')
            this.cardContainer.classList.add('card-position')
            this.appendChild(this.cardContainer)

            this.cardContainer.dropCards = (cards) => this.dropCards(cards)
        }

        get position () {
            return this.getAttribute('position')
        }

        set position (value) {
            this.classList.remove(`position-${this.position}`)
            this.classList.add(`position-${value}`)
            this.setAttribute('position', value)
        }

        dropCards (cards) {
            console.log('recieving cards', cards)
            cards.forEach(card => card.position = this.position);
        }
    }
    customElements.define("card-drop-zone", CardDropZone)

    class PokemonCard extends HTMLElement {
        constructor () {
            super()
            this.setAttribute('onmousedown', 'this.onMouseDown(event)')
            this.setAttribute('ontouchstart', 'this.onTouchStart()')
            this.setAttribute('onmouseup', 'this.onMouseUp()')
            this.setAttribute('ontouchend', 'this.onMouseUp()')
            this.setAttribute('onmouseleave', 'this.onMouseLeave()')
            this.setAttribute('ontouchmove', 'this.onTouchMove(event)')
            this.mouseDown = false
            this.removeSelected = false
            this.longPressTimer
            this.position = this.position

            // this.initialized = false
        }

        connectedCallback () {
            // if (this.initialized == true) return //prevent connectedCallback from triggering every time card gets a new parent
            // this.initialized = true

            this.positionContainer = document.createElement('div')
            this.positionContainer.classList.add('card-position')
            this.appendChild(this.positionContainer)

            this.shadowContainer = document.createElement('div')
            this.shadowContainer.classList.add('card-shadow')
            this.positionContainer.appendChild(this.shadowContainer)

            this.image = document.createElement('card-image')
            this.image.style["backgroundImage"] = `url('${this.getAttribute('image-src')}')`
            this.shadowContainer.appendChild(this.image)

            this.image.dropCards = (cards) => this.dropCards(cards)
        }

        get position () {
            return this.getAttribute('position')
        }

        set position (value) {
            this.classList.remove(`position-${this.position}`)
            this.classList.add(`position-${value}`)
            this.setAttribute('position', value)
        }
        
        onMouseDown (event) {
            if (event.button == 0) this.onClick() //left click
            else if (event.button == 2) this.focus() //right click
        }

        onMouseUp () {
            this.mouseDown = false
            
            if (this.removeSelected == true) {
                this.classList.remove('selected')
                this.removeSelected = false
            }
            
            clearTimeout(this.longPressTimer)
        }

        onTouchStart () {
            event.preventDefault()
            this.onClick()
            this.longPressTimer = setTimeout(() => {
                this.focus()
            }, longPressTime * 1000);
        }

        onClick () {
            this.mouseDown = true
            if (!this.classList.contains('selected')) {
                this.classList.add('selected')
                this.removeSelected = false
            }
            else {
                this.removeSelected = true
            }
        }

        dropCards (cards) {
            // console.log('recieving cards', cards)
            // if (cards.length == 1) alert('1. Evolve\n2. Attach\n3. Switch')
            // else alert('1. Attach')
            cards.forEach(card => card.position = this.position);
        }

        onTouchMove (event) {
            const rect = this.image.getBoundingClientRect()
            const touchX = event.touches[0].clientX
            const touchY = event.touches[0].clientY
            if (rect.x > touchX || rect.x + rect.width < touchX || rect.y > touchY || rect.y + rect.height < touchY) this.onMouseLeave()
        }

        onMouseLeave () {
            if (this.mouseDown == true && document.querySelectorAll('.stack').length == 0) {
                clearTimeout(this.longPressTimer)
                this.removeSelected = false
                document.querySelectorAll('.focused').forEach(elm => elm.classList.remove('focused'))
                document.querySelectorAll('.stack-top').forEach(elm => elm.classList.remove('stack-top'))
                this.classList.add('stack-top')
                document.querySelectorAll('.selected').forEach(elm => elm.classList.add('stack'))
                const animationTimeSeconds = getComputedStyle(document.body).getPropertyValue('--animation-time').split('s')[0]
                const steps = Math.round(animationTimeSeconds * 48)
                for (let i = 0; i < steps+1; i++) {
                    stackAnimationTimeouts.push(
                            setTimeout(() => {
                            setStackPos()
                            css.setProperty('--stack-time', `${animationTimeSeconds * (1 - i / steps)}s`)
                            if (i == steps) {
                                cursorUpdateStackPos = true
                                css.setProperty('--stack-lower-layer-display', 'none')
                            }
                        }, animationTimeSeconds*1000/steps*i)
                    )
                }
                this.mouseDown = false
            }
        }

        focus () {
            if (!this.classList.contains('focused')) {
                document.querySelectorAll('.focused').forEach(elm => elm.classList.remove('focused'))
                this.classList.add('focused')
            }
            else (this.classList.remove('focused'))
        }
    }
    customElements.define("pokemon-card", PokemonCard)
</script>
