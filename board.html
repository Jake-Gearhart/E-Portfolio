<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover">
</head>
<html>
    <body>
        <div id="background" onclick="clearCardSelections()"></div>
        <div style="display: flex">Show Settings:<input type="checkbox" onclick="clearCardSelections(); document.querySelectorAll('.debug').forEach(elm => {if (this.checked == true) elm.classList.remove('debug-hidden'); else elm.classList.add('debug-hidden')})"></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">------------------------ Settings ------------------------</div>
        <div class="debug debug-hidden">(Will be visible in a settings menu)</div>
        <div class="debug debug-hidden">-</div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Max Board Bottom Width:<input type="range" min="100" max="300" value="135" oninput="maxBoardWidth = this.value/100; updateBoardTransform(); document.getElementById('max-board-width-text').innerHTML = `${(this.value/100).toFixed(2)} x Board Height (Default: 1.35)`"><div id="max-board-width-text">1.35 x Board Height (Default: 1.35)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Animation Speed:<input type="range" min="0" max="100" value="7" oninput="css.setProperty('--animation-time', `${this.value/20}s`); document.getElementById('animation-time-text').innerHTML = `${(this.value/20).toFixed(2)}s (Default: 0.35s)`"><div id="animation-time-text">0.35s (Default: 0.35s)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Long Press Time (Touch Screen):<input type="range" min="0" max="300" value="50" oninput="longPressTime = this.value/100; document.getElementById('long-press-time-text').innerHTML = `${(this.value/100).toFixed(2)}s (Default: 0.50s)`"><div id="long-press-time-text">0.50s (Default: 0.50s)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Opponent's Cards Face You:<input type="checkbox" oninput="css.setProperty('--opponent-card-rotation', this.checked ? '0deg' : '180deg')"></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Card Shadow:<input type="checkbox" oninput="css.setProperty('--card-shadow-image', this.checked ? `url('card-shadow.png')` : 'none')" checked></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Holofoil:<input type="checkbox" oninput="css.setProperty('--holofoil-display', this.checked ? 'inline-block' : 'none')" checked></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Zoom Idle Animation:<input type="checkbox" oninput="css.setProperty('--zoom-card-idle-speed', this.checked ? '5s' : '0s')" checked></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">------------------------ Debugging -----------------------</div>
        <div class="debug debug-hidden">(Only for testing)</div>
        <div class="debug debug-hidden">-</div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Board Height:<input type="range" min="0" max="200" value="100" oninput="boardHeightScale = this.value/100; updateBoardTransform(); document.getElementById('board-height-text').innerHTML = `${(this.value/100).toFixed(2)} x Screen Width (Default: 1)`"><div id="board-height-text">1.00 x Screen Width (Default: 1.00)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Top Padding:<input type="range" min="0" max="50" value="5" oninput="paddingTop = this.value/100; updateBoardTransform(); document.getElementById('padding-top-text').innerHTML = `${(this.value/100).toFixed(2)} x Screen Height (Default: 0.05)`"><div id="padding-top-text">0.05 x Board Height (Default: 0.05)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Bottom Padding:<input type="range" min="0" max="50" value="5" oninput="paddingBottom = this.value/100; updateBoardTransform(); document.getElementById('padding-bottom-text').innerHTML = `${(this.value/100).toFixed(2)} x Screen Height (Default: 0.15)`"><div id="padding-bottom-text">0.15 x Board Height (Default: 0.15)</div></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Debug Background:<input type="checkbox" oninput="css.setProperty('--background-color', this.checked ? '#166953' : '#1b7f64')"></div>
        <div class="debug debug-hidden" onclick="clearCardSelections()">Right Click Menu:<input type="checkbox" oninput="debugRightClickMenu = this.checked ? true : false"></div>
        <div style="position: absolute; bottom: 0;">0010</div>
        <game-board></game-board>        
        <pokemon-card class="board-transform position-board-opponent-bench-5" image-src="https://images.pokemontcg.io/swsh12/147_hires.png"></pokemon-card>
        <pokemon-card class="board-transform position-board-opponent-active holofoil" image-src="https://images.pokemontcg.io/sv1/131_hires.png"></pokemon-card>
        <pokemon-card class="board-transform position-board-user-active holofoil" image-src="https://images.pokemontcg.io/swsh6/61_hires.png"></pokemon-card>
        <pokemon-card class="board-transform position-board-user-bench-1 holofoil" image-src="https://images.pokemontcg.io/sv1/86_hires.png"></card-image></pokemon-card>
        <pokemon-card class="board-transform position-board-user-bench-2" image-src="https://images.pokemontcg.io/swsh12/68_hires.png"></pokemon-card>
    </body>
</html>
<style>
    :root {
        /* Global Variables */
        --card-width-height-ratio: calc(862/1152);
        --card-height-width-ratio: calc(1152/862);
        --card-width: 15%;
        --card-height: calc(var(--card-width) * var(--card-height-width-ratio));
        --stack-left: 10%;
        --stack-bottom: 10%;
        --stack-time: 0.35s;
        --stack-lower-layer-display: unset;

        /* Settings */
        --background-color: #1b7f64;
        --opponent-card-rotation: 180deg;
        --card-shadow-image: url('card-shadow.png');
        --holofoil-display: inline-block;
        --animation-time: 0.35s;
        --zoom-card-idle-speed: 5s; /* Set to 0s to disable idle animation */
    }

    .debug {
        display: flex;
        background-color: rgba(0,0,0,0.5);
    }
    .debug-hidden {
        display: none;
    }

    body {
        color: white;
        font-family: monospace;
        overflow: hidden;
    }

    #background {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0;
        top: 0;
        background-color: var(--background-color);
        z-index: -3 !important;
    }

    game-board {
        background-image: url('board.png');
        background-repeat: no-repeat;
        background-size: 100% 100%;
        pointer-events: all !important;
        z-index: -2 !important;
    }

    .board-transform, game-board {
        position: absolute;
        width: var(--board-width);
        height: var(--board-height);
        left: 0;
        bottom: 0;
        transform-origin: center bottom;
        transform: translateX(var(--board-translateX)) translateY(var(--board-translateY)) matrix3d(1,0,0,0,0,1,0,var(--board-depth-transform),0,0,1,0,0,0,0,1);
        pointer-events: none;
        transition: all var(--animation-time);
        z-index: -1;
    }
    .board-transform * {
        transition: all var(--animation-time);
    }

    .board-transform.zoom {
        transform: translateX(var(--board-translateX)) translateY(0);
        z-index: 1000;
    }
    .board-transform.zoom .card-position {
        width: calc(0.4 * var(--board-width)); /* Width of zoomed card = 40% of board width */
        bottom: calc(50vh - 0.4 * var(--board-width) * var(--card-height-width-ratio) / 2); /* Zoomed card is centered vertically */
        left: max(calc(-1 * (100vw - var(--board-width)) / 2 + 3.125vw), calc(var(--board-width)/2 - 0.4 * var(--board-width) - 6.25vw)); /* Zoomed card's left side is at least 1/32 away from the edge of the screen, and the right side is 1/16 away from the center if there's room*/
        animation: card-idle var(--zoom-card-idle-speed) ease-in-out infinite;
        animation-delay: var(--animation-time); /* Wait for zoom to complete before idle animation begins */
    }
    @keyframes card-idle {
        0% {
            transform: translateY(0%);
            animation-timing-function: ease-out;
        }
        25% {
            transform: translateY(0.78125%);
            animation-timing-function: ease-in-out;
        }
        75% {
            transform: translateY(-0.78125%);
            animation-timing-function: ease-in;
        }
    }
    .board-transform.zoom .card-shadow {
        transform: rotate(0) matrix3d(1,0,0,0.0003,0,1,0,0,0,0,1,0,0,0,0,1);
    }

    pokemon-card {
        position: absolute;
        width: 100%;
        height: 100%;
        left: 0%;
        bottom: 0%;

    }
    .stack {
        left: var(--stack-left);
        bottom: var(--stack-bottom);
        transition: all var(--animation-time), left var(--stack-time), bottom var(--stack-time) !important;
        z-index: 550;
    }
    .stack:not(.stack-top) {
        display: var(--stack-lower-layer-display);
        z-index: 450;
    }

    .card-position {
        position: absolute;
        aspect-ratio: var(--card-width-height-ratio);
    }

    .position-board-user-active .card-position {
        width: var(--card-width);
        left: 42.5%;
        bottom: 29%;
    }

    .position-board-user-bench-1 .card-position {
        width: var(--card-width);
        left: 16.5%;
        bottom: 4%;
    }

    .position-board-user-bench-2 .card-position {
        width: var(--card-width);
        left: 30.7%;
        bottom: 4%;
    }

    .position-board-opponent-active .card-position {
        width: var(--card-width);
        left: 42.5%;
        bottom: 52.5%;
    }
    .position-board-opponent-active .card-shadow {
        transform: rotate(var(--opponent-card-rotation))
    }

    .position-board-opponent-bench-5 .card-position {
        width: var(--card-width);
        left: 13%;
        bottom: 75.89%;
    }
    .position-board-opponent-bench-5 .card-shadow {
        transform: rotate(var(--opponent-card-rotation))
    }

    .stack .card-position {
        position: absolute;
        left: calc(50% - var(--card-width) / 2);
        bottom: calc(50% - var(--card-height) / 2);

    }
    .board-transform.stack {
        transform: none;
    }
    .stack .card-shadow {
        transform: rotate(0);
    }

    .card-shadow {
        position: absolute;
        aspect-ratio: var(--card-width-height-ratio);
        width: 100%;
        background-image: var(--card-shadow-image);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        transition: all var(--animation-time), background calc(var(--animation-time) / 4) !important;
    }
    .selected .card-shadow {
        background-image: url('card-highlight.png') !important;
        animation: selected-card 2s ease-in-out infinite;
    }
    @keyframes selected-card {
        0% {
            filter: brightness(1);
        }
        50% {
            filter: brightness(1.25);
        }
    }

    card-image {
        position: absolute;
        aspect-ratio: 734/1024;
        width: calc(73400%/862);
        top: calc(6400%/1152);
        left: calc(6400%/862);
        background-repeat: no-repeat;
        background-size: 100% 100%;
        border-radius: 4.5% / calc(4.5% * var(--card-width-height-ratio));
        pointer-events: all;
    }
    .stack card-image {
        pointer-events: none;
    }

    .holofoil card-image::after {
        content: "";
        position: absolute;
        display: var(--holofoil-display);
        width: 100%;
        height: 100%;
        background-image: url('holofoil.gif');
        background-repeat: no-repeat;
        background-size: 100% 100%;
        mix-blend-mode: color-dodge;
        border-radius: 4.5% / calc(4.5% * var(--card-width-height-ratio));
    }
</style>
<script>
    const css = document.documentElement.style

    let paddingTop = 0.05
    let paddingBottom = 0.15
    let maxBoardWidth = 1.35
    let boardHeightScale = 1
    let longPressTime = 0.5

    let debugRightClickMenu = false

    function updateBoardTransform () {
        const w = Math.min(window.innerWidth, window.innerHeight * (maxBoardWidth / boardHeightScale - paddingTop - paddingBottom))
        css.setProperty('--board-width', `${w}px`)
        const boardHeight = w * boardHeightScale
        css.setProperty('--board-height', `${boardHeight}px`)

        const top_h = paddingTop * window.innerHeight
        const bottom_h = paddingBottom * window.innerHeight 
        const h = window.innerHeight - top_h - bottom_h

        css.setProperty('--board-translateX', `${(window.innerWidth - w) / 2}px`)
        if (boardHeight < h) css.setProperty('--board-translateY', `${(boardHeight - h) / 2 - bottom_h}px`)
        else css.setProperty('--board-translateY', `${-bottom_h}px`)
        css.setProperty('--board-depth-transform', Math.min(0, (h - boardHeight) / (h * boardHeight)))
    }
    updateBoardTransform()

    window.addEventListener('resize', updateBoardTransform)
    function setStackPos () {
        css.setProperty('--stack-left', `calc(${100*cursorPos.x/window.innerWidth}vw - var(--board-width)/2)`)
        css.setProperty('--stack-bottom', `calc(${100 * (window.innerHeight - cursorPos.y) / window.innerHeight}vh - var(--board-height)/2)`)
    }
    let cursorUpdateStackPos = false
    let cursorPos
    window.addEventListener('mousemove', (event) => {
        cursorPos = {'x': event.clientX, 'y': event.clientY}
        if (cursorUpdateStackPos == true) setStackPos()
    })
    window.addEventListener('touchmove', (event) => {
        cursorPos = {'x': event.touches[0].clientX, 'y': event.touches[0].clientY}
        if (cursorUpdateStackPos == true) setStackPos()
    })
    window.addEventListener('contextmenu', (event) => {
        if (debugRightClickMenu == false) event.preventDefault()
    })

    function clearCardSelections () {
        document.querySelectorAll('.zoom').forEach(elm => elm.classList.remove('zoom'))
        document.querySelectorAll('.selected').forEach(elm => elm.classList.remove('selected'))
        clearCardStack()
    }

    let stackAnimationTimeouts = []
    function clearCardStack () {
        document.querySelectorAll('.stack').forEach(elm => elm.classList.remove('stack'))
        css.setProperty('--stack-time', getComputedStyle(document.body).getPropertyValue('--animation-time'))
        stackAnimationTimeouts.forEach(timeout => clearTimeout(timeout));
        cursorUpdateStackPos = false
    }

    class GameBoard extends HTMLElement {
        constructor () {
            super()
            this.setAttribute('onclick', 'this.onClick()')
        }

        onClick () {
            clearCardSelections()
        }
    }
    customElements.define("game-board", GameBoard)

    class PokemonCard extends HTMLElement {
        constructor () {
            super()
            this.setAttribute('onmousedown', 'this.onMouseDown(event)')
            this.setAttribute('ontouchstart', 'this.onTouchStart()')
            this.setAttribute('onmouseup', 'this.onMouseUp()')
            this.setAttribute('ontouchend', 'this.onMouseUp()')
            this.setAttribute('onmouseleave', 'this.onMouseLeave()')
            this.setAttribute('ontouchmove', 'this.onTouchMove(event)')
            this.mouseDown = false
            this.removeSelected = false
            this.longPressTimer
        }

        connectedCallback () {
            this.positionContainer = document.createElement('div')
            this.positionContainer.classList.add('card-position')
            this.appendChild(this.positionContainer)

            this.shadowContainer = document.createElement('div')
            this.shadowContainer.classList.add('card-shadow')
            this.positionContainer.appendChild(this.shadowContainer)

            this.image = document.createElement('card-image')
            this.image.style["backgroundImage"] = `url('${this.getAttribute('image-src')}')`
            this.shadowContainer.appendChild(this.image)
        }
        
        onMouseDown (event) {
            if (event.button == 0) this.onClick() //left click
            else if (event.button == 2) this.zoom() //right click
        }

        onMouseUp () {
            this.mouseDown = false
            
            if (this.removeSelected == true) {
                this.classList.remove('selected')
                this.removeSelected = false
            }
            
            clearTimeout(this.longPressTimer)
            clearCardStack()
        }

        onTouchStart () {
            event.preventDefault()
            this.onClick()
            this.longPressTimer = setTimeout(() => {
                this.zoom()
            }, longPressTime * 1000);
        }

        onClick() {
            this.mouseDown = true
            if (!this.classList.contains('selected')) {
                this.classList.add('selected')
                this.removeSelected = false
            }
            else {
                this.removeSelected = true
            }
            clearCardStack()
        }

        onTouchMove (event) {
            const rect = this.image.getBoundingClientRect()
            const touchX = event.touches[0].clientX
            const touchY = event.touches[0].clientY
            if (rect.x > touchX || rect.x + rect.width < touchX || rect.y > touchY || rect.y + rect.height < touchY) this.onMouseLeave()
        }

        onMouseLeave () {
            if (this.mouseDown == true && document.querySelectorAll('.stack').length == 0) {
                clearTimeout(this.longPressTimer)
                this.removeSelected = false
                document.querySelectorAll('.zoom').forEach(elm => elm.classList.remove('zoom'))
                document.querySelectorAll('.stack-top').forEach(elm => elm.classList.remove('stack-top'))
                this.classList.add('stack-top')
                document.querySelectorAll('.selected').forEach(elm => elm.classList.add('stack'))
                cursorUpdateStackPos = false
                css.setProperty('--stack-lower-layer-display', 'unset')
                const animationTimeSeconds = getComputedStyle(document.body).getPropertyValue('--animation-time').split('s')[0]
                const steps = Math.round(animationTimeSeconds * 48)
                for (let i = 0; i < steps+1; i++) {
                    stackAnimationTimeouts.push(
                            setTimeout(() => {
                            setStackPos()
                            css.setProperty('--stack-time', `${animationTimeSeconds * (1 - i / steps)}s`)
                            if (i == steps) {
                                cursorUpdateStackPos = true
                                css.setProperty('--stack-lower-layer-display', 'none')
                            }
                        }, animationTimeSeconds*1000/steps*i)
                    )
                }
                this.mouseDown = false
            }
        }

        zoom () {
            if (!this.classList.contains('zoom')) {
                document.querySelectorAll('.zoom').forEach(elm => elm.classList.remove('zoom'))
                this.classList.add('zoom')
            }
            else (this.classList.remove('zoom'))
        }
    }
    customElements.define("pokemon-card", PokemonCard)
</script>
